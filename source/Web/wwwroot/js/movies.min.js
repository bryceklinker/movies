(function(angular) {
    var module = angular.module('movies', []);

    module.constant('config', {
        apiUrl: 'http://localhost:8181'
    });

    module.constant('events', {
        searchFinished: 'SearchFinished',
        searchStarted: 'SearchStarted',
        search: 'Search',
        play: 'Play'
    });

    module.config(['$sceProvider', function($sceProvider) {
        $sceProvider.enabled(false);
    }]);
})(angular = window.angular || {});
(function(angular) {
    var Subscriber = function(event, callback) {
        this._event = event;
        this._callback = callback;
    };

    Subscriber.prototype.handles = function(event) {
        return this._event === event;
    };

    Subscriber.prototype.handle = function(args) {
        this._callback(args);
    };

    var EventBus = function() {
        this._subscribers = [];
    };

    EventBus.prototype.subscribe = function(event, callback) {
        var subscriber = new Subscriber(event, callback);
        this._subscribers.push(subscriber);
    };

    EventBus.prototype.publish = function(event, args) {
        var count = this._subscribers.length;
        for (var i = 0; i < count; i++) {
            var subscriber = this._subscribers[i];
            if (subscriber.handles(event)) {
                subscriber.handle(args);
            }
        }
    };

    var instance = undefined;
    angular.module('movies').factory('eventBus', function() {
        if (instance === undefined)
            instance = new EventBus();
        return instance;
    });
})(angular = window.angular || {});
(function (angular) {
    angular.module('movies').controller('playerController', ['$scope', 'config', 'events', 'eventBus', function($scope, config, events, eventBus) {
        function handlePlayMovie(args) {
            $scope.videoSource = config.apiUrl + '/play/' + args.title;
        }

        eventBus.subscribe(events.playMovie, handlePlayMovie);
    }]);
})(angular = window.angular || {});
(function(angular) {
    angular.module('movies').controller('searchFormController', ['$scope', 'events', 'eventBus', function($scope, events, eventBus) {
        $scope.search = function() {
            var searchArgs = { title: $scope.title };
            eventBus.publish(events.search, searchArgs);
        };

        function handleSearchStarted() {
            $scope.isSearching = true;
        }

        function handleSearchFinished() {
            $scope.isSearching = false;
        }

        eventBus.subscribe(events.searchStarted, handleSearchStarted);
        eventBus.subscribe(events.searchFinished, handleSearchFinished);
    }]);
})(angular = window.angular || {});
(function(angular) {
    angular.module('movies').controller('searchResultsController', ['$scope', '$http', 'config', 'events', 'eventBus', function($scope, $http, config, events, eventBus) {
        function handleSearch(args) {
            eventBus.publish(events.searchStarted);
            var url = config.apiUrl + '/search?title=' + args.title;
            $http.get(url)
                .success(searchFinished)
                .error(searchFailed);
        }

        function searchFailed(error) {
            eventBus.publish(events.searchFinished, false);
        }

        function searchFinished(data) {
            $scope.movies = data.movies;
            eventBus.publish(events.searchFinished, true);
        }

        $scope.play = function(movie) {
            eventBus.publish(events.playMovie, movie);
        };

        eventBus.subscribe(events.search, handleSearch);
    }]);
})(angular = window.angular || {});