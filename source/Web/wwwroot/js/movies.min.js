(function(angular) {
    var module = angular.module('movies', []);

    module.constant('config', {
        apiUrl: 'http://localhost:8181'
    });

    module.constant('events', {
        searchFinished: 'SearchFinished',
        searchStarted: 'SearchStarted',
        search: 'Search',
        play: 'Play'
    });

    module.config(['$sceProvider', function($sceProvider) {
        $sceProvider.enabled(false);
    }]);
})(angular = window.angular || {});
(function(angular) {
    var Subscriber = function(event, callback) {
        this._event = event;
        this._callback = callback;
    };

    Subscriber.prototype.handles = function(event) {
        return this._event === event;
    };

    Subscriber.prototype.handle = function(args) {
        this._callback(args);
    };

    var EventBus = function() {
        this._subscribers = [];
    };

    EventBus.prototype.subscribe = function(event, callback) {
        var subscriber = new Subscriber(event, callback);
        this._subscribers.push(subscriber);
    };

    EventBus.prototype.publish = function(event, args) {
        var count = this._subscribers.length;
        for (var i = 0; i < count; i++) {
            var subscriber = this._subscribers[i];
            if (subscriber.handles(event)) {
                subscriber.handle(args);
            }
        }
    };

    var instance = undefined;
    angular.module('movies').factory('eventBus', function() {
        if (instance === undefined)
            instance = new EventBus();
        return instance;
    });
})(angular = window.angular || {});
(function() {
    function isFunction(value) {
        var getType = {};
        return value && getType.toString.call(value) === '[object Function]';
    }

    var Registration = function(constructorOrInstance, injector) {
        this._constructor = constructorOrInstance;
        this._injector = injector;
    };
    Registration.prototype.get = function() {
        return this.create();
    };
    Registration.prototype.create = function() {
        var argsRegex = /^function\s*[^\(]*\(\s*([^\)]*)\)/m;
        var functionString = this._constructor.toString();
        var argNames = functionString.match(argsRegex)[1].replace(/ /g, '').split('');

        var args = [];
        for (var i = 0; i < argNames.length; i++) {
            var instance = this._injector.get(argNames[i]);
            args.push(instance);
        }
        return Object.create(this._constructor, args);
    };

    var Singleton = function (constructorOrInstance, injector) {
        Registration.call(this, constructorOrInstance, injector);

        if (!isFunction(constructorOrInstance))
            this._instance = constructorOrInstance;
    };
    Singleton.prototype.get = function() {
        if (this._instance !== undefined)
            return this._instance;

        this._instance = this.create();
        return this._instance;
    };

    var Injector = function () {
        this._registrations = {};
    };
    Injector.prototype.get = function(name) {
        if (!this._registrations.hasOwnProperty(name))
            throw 'Nothing has been registered with name "' + name + '"';

        return this._registrations[name].get();
    };
    Injector.prototype.addTransient = function(name, constructor) {
        if (this._registrations.hasOwnProperty(name))
            throw 'The name "' + name + '" has already been registered';

        this._registrations[name] = new Registration(constructor, this);
    };
    Injector.prototype.addSingleton = function(name, constructorOrInstance) {
        if (this._registrations.hasOwnProperty(name))
            throw 'The name "' + name + '" has already been registered';

        this._registrations[name] = new Singleton(constructorOrInstance, this);
    };

    window.klinject = window.klinject || {};
    window.klinject.instance = new Injector();
})();
(function (angular) {
    angular.module('movies').controller('playerController', ['$scope', 'config', 'events', 'eventBus', function($scope, config, events, eventBus) {
        function handlePlayMovie(args) {
            $scope.videoSource = config.apiUrl + '/play/' + args.title;
        }

        eventBus.subscribe(events.playMovie, handlePlayMovie);
    }]);
})(angular = window.angular || {});
(function(angular) {
    angular.module('movies').controller('searchFormController', ['$scope', 'events', 'eventBus', function($scope, events, eventBus) {
        $scope.search = function() {
            var searchArgs = { title: $scope.title };
            eventBus.publish(events.search, searchArgs);
        };

        function handleSearchStarted() {
            $scope.isSearching = true;
        }

        function handleSearchFinished() {
            $scope.isSearching = false;
        }

        eventBus.subscribe(events.searchStarted, handleSearchStarted);
        eventBus.subscribe(events.searchFinished, handleSearchFinished);
    }]);
})(angular = window.angular || {});
(function(angular) {
    angular.module('movies').controller('searchResultsController', ['$scope', '$http', 'config', 'events', 'eventBus', function($scope, $http, config, events, eventBus) {
        function handleSearch(args) {
            eventBus.publish(events.searchStarted);
            var url = config.apiUrl + '/search?title=' + args.title;
            $http.get(url)
                .success(searchFinished)
                .error(searchFailed);
        }

        function searchFailed(error) {
            eventBus.publish(events.searchFinished, false);
        }

        function searchFinished(data) {
            $scope.movies = data.movies;
            eventBus.publish(events.searchFinished, true);
        }

        $scope.play = function(movie) {
            eventBus.publish(events.playMovie, movie);
        };

        eventBus.subscribe(events.search, handleSearch);
    }]);
})(angular = window.angular || {});